# Terraform deployment

TODO write this up properly

## Clone repo

```bash
git clone  https://github.com/GoogleCloudPlatform/docker-clamav-malware-scanner.git
cd docker-clamav-malware-scanner
```

## Create a project and assign billing

console blah blah blah

## Init environment

```bash

PROJECT_ID=MY_PROJECT_ID
gcloud config set project $PROJECT_ID

TF_VAR_project_id=$PROJECT_ID
TF_VAR_region=us-central1
TF_VAR_bucket_location=us
TF_VAR_config_json=$(cat <<EOF
{
  "buckets": [
    {
      "unscanned": "unscanned-${PROJECT_ID}",
      "clean": "clean-${PROJECT_ID}",
      "quarantined": "quarantined-${PROJECT_ID}"
    }
  ],
  "ClamCvdMirrorBucket": "cvd-mirror-${PROJECT_ID}"
}
EOF
)
TF_VAR_create_buckets=true
export TF_VAR_project_id TF_VAR_region TF_VAR_bucket_location TF_VAR_config_json TF_VAR_create_buckets
```

## Enable core APIs to allow terraform to function

```bash
gcloud services enable cloudresourcemanager.googleapis.com serviceusage.googleapis.com
```

or
[via the console](https://console.cloud.google.com/flows/enableapi?apiid=serviceusage.googleapis.com,cloudresourcemanager.googleapis.com).

## Create core infra and service accounts

```bash
cd terraform/infra
terraform apply -auto-approve
```

## Build the malware scanner service image

```bash
cd ../../cloudrun-malware-scanner

gcloud builds submit --region=$TF_VAR_region --config=cloudbuild.yaml  --service-account=projects/$PROJECT_ID/serviceAccounts/malware-scanner-build@$PROJECT_ID.iam.gserviceaccount.com .
```

## Deploy the service and connect infra to service with eventarc

```bash
cd ../terraform/service/
terraform init
terraform apply -auto-approve
```

Note: if you get the error:

> **Error:** Error creating Trigger: googleapi: Error 400: Invalid resource
> state for "": Permission denied while using the Eventarc Service Agent. If you
> recently started to use Eventarc, it may take a few minutes before all
> necessary permissions are propagated to the Service Agent. Otherwise, verify
> that it has Eventarc Service Agent role.

Simply retry running `terraform apply -auto-approve`

Last line of output should show:

```text
Outputs:

cloud_run_uri = "https://malware-scanner-xxxxxxx-xx.a.run.app"
```

## Test the service

### Get version info from cloud run

Use that URL in the following command:

```bash
MALWARE_SCANNER_URL="$(terraform output -raw cloud_run_uri)"
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)"  \
   "${MALWARE_SCANNER_URL}"
```

Should output lines showing the versions of the malware scanner, ClamAV and the
current malware definition package database version/date.

```text
gcs-malware-scanner version 3.0.0
Using Clam AV version: ClamAV 1.0.5/27396/Thu Sep 12 08:46:40 2024

Service to scan GCS documents for the malware and move the analyzed documents to appropriate buckets
```

### Create and scan a clean file and an simulated infected file

```bash
echo -e 'HELLO WORLD!' \
    | gcloud storage cp - "gs://unscanned-${PROJECT_ID}/clean.txt"
echo -e 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' \
    | gcloud storage cp - "gs://unscanned-${PROJECT_ID}/eicar-infected.txt"
```

Check the unscanned bucket

```bash
gcloud storage ls gs://unscanned-${PROJECT_ID}/
```

Should have no results (if the files still exist, recheck after a couple of
seconds)

Check the clean files bucket

```bash
gcloud storage ls gs://clean-${PROJECT_ID}/
```

should show

```text
gs://clean-PROJECT_ID/clean.txt
```

Check the quarantined bucket

```bash
gcloud storage ls gs://quarantined-${PROJECT_ID}/
```

should show the infected file in quarantined bucket

```text
gs://clean-PROJECT_ID/eicar-infected.txt
```
